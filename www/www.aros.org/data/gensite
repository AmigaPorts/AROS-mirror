#!/usr/bin/env python

'''Generate the AROS WWW site.'''

import glob
from util import *

import news
news.gen (datadir)

import status
status.gen ()

def genDocumentation ():

    page = Page (linkBoxItem='Documentation')
    # Put the old docs here
    page.meat = page.meat + [Text ('Please choose a link to the left')]
    page.write ('documentation.html')

def genScreenshots ():
    '''Create a page with screenshots.'''

    page = Page (linkBoxItem='Screenshots')

    # First, the pictures of AROS developers, etc.
    tn1 = Thumbnail ('pics/developers/Digulla-2.jpg')
    tn2 = Thumbnail ('pics/developers/Digulla-1.jpg')
    tn3 = Thumbnail ('pics/developers/nlorentz.jpg')
    page.meat = page.meat + [
	Name ('Pictures around AROS'),
	Heading (2, 'Pictures around AROS'),
	Paragraph ('If you ever wanted to know what Aaron "Optimizer" Digulla'
	    ' looks like, here are two pictures:'),
	ThumbnailTable (tn1, tn2),
	Paragraph ('Picture of Nils Henrik Lorentzen:'),
	ThumbnailTable (tn3),
	Paragraph ('Hopefully, more pictures of AROS developers will'
	    ' show up here :-)'),
	Name ('Screenshots'),
	Heading (2, 'Screenshots'),
    ]

    page.linksToFix.append (tn1.href)
    page.imagesToFix.append (tn1.img)
    page.linksToFix.append (tn2.href)
    page.imagesToFix.append (tn2.img)
    page.linksToFix.append (tn3.href)
    page.imagesToFix.append (tn3.img)

    def processDir (dir, page=page):
	'''Read a directory and put all pictures in it into ThumbnailTables.
	The name of the directory must be YYYYMMDD.'''
	str = os.path.basename (dir)
	date = '%d.%d.%d' % (
	    int (str[6:8]),
	    int (str[4:6]),
	    int (str[0:4]),
	)
	fh = open (os.path.join (dir, 'README'), 'r')
	text = fh.read ()
	fh.close ()
	
	list = [
	    Paragraph (RawText ('%s - %s' % (date, text))),
	]
	files = glob.glob (os.path.join (dir, "*.*"))
	files.sort ()
	pics = []
	for file in files:
	    if file[-4:] == '.txt' or string.find (file, '_mini.') != -1:
		continue

	    tn = Thumbnail (
		os.path.join (
		    screenshoturl,
		    str,
		    os.path.basename (file)
		)
	    )
	    pics.append (tn)
	    page.linksToFix.append (tn.href)
	    page.imagesToFix.append (tn.img)
	
	list.append (apply (ThumbnailTable, pics))
	return list
	    
    # Read all screenshots and sort them by date.
    dirs = glob.glob (os.path.join (screenshoturl, '[0-9]*'))
    dirs.sort ()
    dirs.reverse ()
    for dir in dirs:
	page.meat = page.meat + processDir (dir)

    page.write ('screenshots.html')

def genDownload ():
    page = Page (linkBoxItem='Download')
    # Create the page for downloads
    page.meat = page.meat + [Text ('Please choose a link to the left.')]
    page.write ('download.html')

def genSnapshots ():
    '''Create the page with the snapshots with sizes and links for
    download.'''
    page = Page (linkBoxItem='Snapshots')

    files = glob.glob (os.path.join (ftpdir, 'snapshots/*.tgz'))
    if not files:
        page.meat = page.meat + [Text ('No snapshots found')]
    else:
	dict = {}
	columns = {}
	days = {}

	for file in files:
	    ss = Snapshot (file)
	    day = dict.get (ss.date, None)
	    if not day:
		day = {}
		dict[ss.date] = day
	    if ss.ext != 'tgz':
		print 'Unknown Snapshot', file
		continue

	    day[ss.title] = ss
	    columns[ss.title] = None
	    days[ss.date] = None
	
	table = TableLite (cellpadding=15, border=2)
	page.meat = page.meat + [table]
	
	colList = columns.keys ()
	colList.sort ()
	row = TR ()
	table.append (row)
	td = TH ('Date')
	row = row + [td]
	    
	for col in colList:
	    td = TH (col)
	    row = row + [td]
	
	dateList = days.keys ()
	dateList.sort ()
	dateList.reverse ()
	for date in dateList:
	    row = TR ()
	    table.append (row)

	    str = '%d.%d.%d' % (
		int (date[6:8]),
		int (date[4:6]),
		int (date[0:4]),
	    )
	    row = row + [TD (str)]

	    day = dict.get (date, {})

	    for col in colList:
		t = Text ()
		ss = day.get (col, None)
		if ss:
		    t.append (Href ('ftp://ftp.aros.org/pub/aros/snapshots/%s' % ss.filename,
			ss.size
		    ))
		
		    if ss.log:
			t.append ('(Log: ')
			t.append (Href (
			    'ftp://ftp.aros.org/pub/aros/snapshots/%s' % \
				ss.log.filename,
			    ss.log.size
			))
			t.append (')')
		    else:
			if not ss.title in ('contrib', 'source'):
			    t.append ('(No log)')
		else:
		    t.append ('-')

		row = row + [TD (t)]

    page.write ('snapshots.html')

def processLinks (links):
    list = List ()

    for link in links:
	if type (link) == type (()):
	    link, children = link[0], link[1:]
	else:
	    children = None

	text = Text (link.href)
	if link.text:
	    if type (link.text) == type (()):
		t = Text ()
		for item in link.text:
		    t.append (item)
	    else:
		t = Text (link.text)
	    text.append (t)
	if link.logo:
	    text.append (Image ((link.logo)))

	list.append (text)
	
	if children:
	    sublist = processLinks (children)
	    list.append (sublist)
    
    return list

def genLinks ():
    '''Create a page with links from links.py.'''
    def processSection (links, title):
	body = []

	#print title, list

	body.append (Name (title))
	body.append (Heading (2, title))
	try:
	    list = processLinks (links)
	except:
	    print 'processSection',title
	    raise
	body.append (list)

	return body

    page = Page (linkBoxItem='Links')

    from links import moreRelated, articles, homepages, lessRelated

    page.meat = page.meat \
	+ processSection (moreRelated, 'More Related') \
	+ processSection (articles, 'Articles') \
	+ processSection (homepages, 'Homepages') \
	+ processSection (lessRelated, 'Less Related')

    page.write ('links.html')

import xml2html

def genXmlPage (filename, linkBoxItem):
    xml2html.XmlPage (os.path.join (arosdir, 'docs', 'src', filename + '.xml'),
	linkBoxItem=linkBoxItem,
    ).write (filename + '.html')

# Call all generators in turn
genDocumentation ()

genXmlPage ('background', 'Background')
genXmlPage ('cvs', 'CVS')

import faq2html
faq2html.gen (arosRC, 'FAQ', os.path.join (arosdir, 'docs', 'faq')).write ('faq.html')

genXmlPage ('mmake', 'MetaMake')
genXmlPage ('style', 'Coding Style')
genXmlPage ('xml', 'AROS XML')
genXmlPage ('hidd-intro', 'HIDD Intro')
genXmlPage ('hidd-model', 'HIDD Model')
genXmlPage ('filesys', 'Filesystems')
genXmlPage ('ideas', 'Random Ideas')

import contents2html
contents2html.gen ()

import htmlautodocs
htmlautodocs.gen ()

genScreenshots ()
genDownload ()
genSnapshots ()
genLinks ()
