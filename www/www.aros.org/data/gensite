#!/usr/bin/env python

'''Generate the AROS WWW site.'''

import glob, os
from HTMLcolors import *
from HTMLgen import *

htmldir = os.environ['HTMLDIR']

mainLinks = (
    ( Href ('/index.html', 'NEWS'),
	Href ('/status.html', 'Status'),
	Href ('/oldnews.html', 'Old News'),
    ),
    ( Href ('/documentation.html', 'Documentation'),
	Href ('/autodocs/index.html', 'AutoDocs'),
    ),
    ( Href ('/screenshots.html', 'Screenshots'),
    ),
    ( Href ('/download.html', 'Download'),
    ),
    ( Href ('/links.html', 'Links'),
	Href ('/links.html#More Related', 'More Related'),
	Href ('/links.html#Articles', 'Articles'),
	Href ('/links.html#Homepages', 'Homepages'),
	Href ('/links.html#Less Related', 'Less Related'),
    ),
)

class Page (SeriesDocument):
    def __init__ (self, rcFile='aros.rc', linkBoxItem='', **kw):
	apply (SeriesDocument.__init__, (self, rcFile,), kw)

	table = TableLite ()
	self.banner = table
	row = TR ()
	table.append (row)
	td = TD (valign='TOP')
	logo = Href ('/', Image (('pics/logo.gif', 300, 123), alt='AROS'))
	td = td + [logo]
	row = row + [td, TD (Text ('Amiga Research OS'))]

	# HTMLgen expects a tuple in self.logo
	#self.logo = Href ('/', Image (('pics/minilogo.gif', 71, 28), alt='AROS'))

	table = TableLite ()
	self.append (table)
	row = TR ()
	table.append (row)
	td = TD (valign='TOP')
	row = row + [td,]
	table2 = TableLite ()
	td = td + [table2,]
	row2 = TR ()
	table2.append (row2)
	td2 = TD (bgcolor='#40FF80', valign='TOP')
	row2 = row2 + [td2]
	self.linkbox = Font (size='-2')
	td2 = td2 + [self.linkbox]

	self.meat = TD (valign='TOP')
	row = row + [self.meat]

	self.gohome = '/'

	if linkBoxItem:
	    list = []
	    for links in mainLinks:
		if links[0].text == linkBoxItem:
		    list.append (links)
		else:
		    list.append ((links[0],))

	    
	    for links in list:
		self.linkbox = self.linkbox + [links[0], BR ()]
		for link in links[1:]:
		    self.linkbox = self.linkbox + [
			RawText ('&nbsp;&nbsp;&nbsp;'),
			link, BR ()]

    def write (self, filename):
	SeriesDocument.write (self, os.path.join (htmldir, filename))

def genNews ():
    list = glob.glob ('news/*')
    list.remove ('news/CVS')
    list.sort ()
    list.reverse ()
    
    def genPage (items, filename):
	def prepareNewsItem (filename):
	    row = TR ()
	    td = TD (bgcolor='#80C0F0', valign='TOP')
	    row = row + [td]
	    str = os.path.basename (filename)
	    date = '%d.%d.%d' % (
		int (str[6:8]),
		int (str[4:6]),
		int (str[0:4]),
	    )
	    td = td + [Name (str), date]

	    td = TD (valign='TOP')
	    row = row + [td]

	    fh = open (filename, 'r')
	    body = fh.read ()
	    fh.close ()

	    body = string.replace (body, '\n\n', '<P>\n\n')
	    td = td + [RawText (body)]
	    
	    return row
	    
	page = Page (linkBoxItem='NEWS')
	table = TableLite ()
	page.meat = page.meat + [table,]

	for file in items:
	    item = prepareNewsItem (file)
	    table.append (item)

	if filename == 'index.html':
	    p = Paragraph ()
	    p.append (Href ('oldnews.html', 'Older News'))
	    page.meat = page.meat + [p]
	else:
	    page.gotop = '/'

	page.write (filename)

    genPage (list[:5], 'index.html')
    genPage (list[5:], 'oldnews.html')

def genStatus ():
    page = Page (linkBoxItem='NEWS')
    body = []
    body.append (Heading (2, 'Size of AROS sources'))
    body.append (Paragraph (Image ('aros_size.png')))
    body.append (Paragraph (Href ('aros_size.jpg', 'Also as JPEG')))
    body.append (Heading (2, 'Size of contributed sources'))
    body.append (Paragraph (Image ('contrib_size.png')))
    body.append (Paragraph (Href ('contrib_size.jpg', 'Also as JPEG')))
    page.meat = page.meat + body
    page.write ('status.html')

def genDocumentation ():
    page = Page (linkBoxItem='Documentation')
    page.write ('documentation.html')

def genScreenshots ():
    page = Page (linkBoxItem='Screenshots')
    page.write ('screenshots.html')

def genDownload ():
    page = Page (linkBoxItem='Download')
    page.write ('download.html')

def processLinks (links):
    list = List ()

    for link in links:
	if type (link) == type (()):
	    link, children = link[0], link[1:]
	else:
	    children = None

	text = Text (link.href)
	if link.text:
	    if type (link.text) == type (()):
		t = Text ()
		for item in link.text:
		    t.append (item)
	    else:
		t = Text (link.text)
	    text.append (t)
	if link.logo:
	    text.append (Image ((link.logo, 0,0)))

	list.append (text)
	
	if children:
	    sublist = processLinks (children)
	    list.append (sublist)
    
    return list

def genLinks ():
    def processSection (links, title):
	body = []

	#print title, list

	body.append (Name (title))
	body.append (Heading (2, title))
	list = processLinks (links)
	body.append (list)

	return body

    page = Page (linkBoxItem='Links')

    from links import moreRelated, articles, homepages, lessRelated

    page.meat = page.meat \
	+ processSection (moreRelated, 'More Related') \
	+ processSection (articles, 'Articles') \
	+ processSection (homepages, 'Homepages') \
	+ processSection (lessRelated, 'Less Related')

    page.write ('links.html')

genNews ()
genStatus ()
genDocumentation ()
genScreenshots ()
genDownload ()
genLinks ()
